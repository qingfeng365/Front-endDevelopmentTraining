# 第14讲 组件生命周期

## 组件生命周期钩子

### 组件初始化

- constructor
- ngOnChanges
- ngOnInit
- ngDoCheck
- ngAfterContentInit
- ngAfterContentChecked
- ngAfterViewInit
- ngAfterViewChecked

### 变更检测

- ngOnChanges
- ngDoCheck
- ngAfterContentChecked
- ngAfterViewChecked

### 组件销毁

- ngOnDestroy

## 示例1

`ng g c life`

`/src/app/life/life.component.ts`

```ts

import {
  Component, OnInit, OnChanges, DoCheck, AfterContentInit,
  AfterContentChecked, AfterViewInit, AfterViewChecked,
  SimpleChanges,
  Input,
  OnDestroy
} from '@angular/core';

let logIndex = 1;

@Component({
  selector: 'app-life',
  templateUrl: './life.component.html',
  styleUrls: ['./life.component.css']
})
export class LifeComponent implements OnInit, OnChanges,
  DoCheck, AfterContentInit, AfterContentChecked,
  AfterViewInit, AfterViewChecked,
  OnDestroy {

  @Input()
  name: string;

  logIt(msg: string) {
    console.log(`#${logIndex++} ${msg}`);
  }

  ngOnDestroy(): void {
    this.logIt('ngOnDestroy');
  }
  ngAfterViewChecked(): void {
    this.logIt('ngAfterViewChecked');
  }
  ngAfterViewInit(): void {
    this.logIt('ngAfterViewInit');
  }
  ngAfterContentChecked(): void {
    this.logIt('ngAfterContentChecked');
  }
  ngAfterContentInit(): void {
    this.logIt('ngAfterContentInit');
  }
  ngDoCheck(): void {
    this.logIt('ngDoCheck');
  }
  ngOnChanges(changes: SimpleChanges): void {
    const currentValue = changes['name'].currentValue;
    this.logIt('ngOnChanges name属性在ngOnChanges里的值是:' + this.name + 
    ', changes["name"].currentValue:' + currentValue);
  }

  constructor() {
    this.logIt('constructor name属性在constructor里的值是:' + this.name);
  }

  ngOnInit() {
    this.logIt('ngOnInit name属性在ngOnInit里的值是:' + this.name);
  }

}

```


`/src/app/app.component.ts`

```ts
//...
export class AppComponent {
  title = 'abc';
  //...
}
```

`/src/app/app.component.html`

```html
<app-life [name]="title"></app-life>
```


执行结果:

```
#1 constructor name属性在constructor里的值是:undefined
#2 ngOnChanges name属性在ngOnChanges里的值是:abc, changes["name"].currentValue:abc
#3 ngOnInit name属性在ngOnInit里的值是:abc
#4 ngDoCheck
#5 ngAfterContentInit
#6 ngAfterContentChecked
#7 ngAfterViewInit
#8 ngAfterViewChecked
#9 ngDoCheck
#10 ngAfterContentChecked
#11 ngAfterViewChecked
```


### ngOnChanges

只有在输入属性变更时,该钩子才会被执行
并会在组件创建后首先执行一次
即对组件进行属性绑定时,如 `[name]="title"`
在`constructor` 阶段还没有处理 `[name]`
在`constructor`执行后,才会处理 `[name]="title"`

```ts
  ngOnChanges(changes: SimpleChanges): void {
    const currentValue = changes['name'].currentValue;
    this.logIt('ngOnChanges name属性在ngOnChanges里的值是:' + this.name + 
    ', changes["name"].currentValue:' + currentValue);
  }
```

`ngOnChanges` 在  `constructor` 之后, `ngOnInit` 之前会被执行一次

如果以后, 输入属性又有变化, 则 `ngOnChanges` 会再次执行, 但`ngOnInit`不会执行


### ngOnChanges的例子

`ng g c child`

`/src/app/child/child.component.ts`

```ts
import { Component, OnInit, Input, OnChanges, SimpleChanges } from '@angular/core';

@Component({
  selector: 'app-child',
  templateUrl: './child.component.html',
  styleUrls: ['./child.component.css']
})
export class ChildComponent implements OnInit,
  OnChanges {

  @Input()
  greeting: string;

  @Input()
  user: { name: string };

  message = '初始化消息';

  ngOnChanges(changes: SimpleChanges): void {
     console.log(JSON.stringify(changes, null, 2));
  }

  constructor() { }

  ngOnInit() {
  }

}

```

`/src/app/child/child.component.html`

```html
<div class="child">
  <h2>我是子组件</h2>
  <div>问候语:{{greeting}}</div>
  <div>姓名:{{user.name}}</div>
  <div>消息: <input [(ngModel)]="message"></div>
</div>
```

`/src/app/app.component.ts`

```ts
import { Component } from '@angular/core';

@Component({
  selector: 'app-root',
  templateUrl: './app.component.html',
  styleUrls: ['./app.component.css']
})
export class AppComponent {

  greeting = 'Hello';
  user: { name: string } = { name: 'Tom' };

}


```

`/src/app/app.component.html`

```html
<div class="parent">
  <h2>我是父组件</h2>
  <div>
    问候语:<input type="text" [(ngModel)]="greeting">
  </div>
  <div>
    姓名:<input type="text" [(ngModel)]="user.name">
  </div>
  <app-child [greeting]="greeting" [user]="user"></app-child>
</div>
```

说明:


- `ngOnChanges` 是当输入属性本身被改变时,且改变是由父组件引起时,才会触发
- 如果输入属性是对象,仅对象的属性值变化,不会触发
- 如果输入属性是对象,要对象与上一个对象不是同一个对象时,才会触发
- 虽然不会触发,但属性值的变更是可以被捕捉到的
- `SimpleChanges`包含所有有改变的输入属性
- 组件非输入属性值改变

输出结果:

初始化时

```js
{
  "greeting": {
    "currentValue": "Hello",
    "firstChange": true
  },
  "user": {
    "currentValue": {
      "name": "Tom"
    },
    "firstChange": true
  }
}
```

修改 Hello 为 Hello1

```
{
  "greeting": {
    "previousValue": "Hello",
    "currentValue": "Hello1",
    "firstChange": false
  }
}
```


