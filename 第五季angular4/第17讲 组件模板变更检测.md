# 第17讲 组件模板变更检测

## AfterViewInit与AfterViewChecked

`AfterView` 是指组件的视图组装完成后触发的钩子

`AfterViewInit` 只触发一次

子组件视图先组装完成,然后才到父组件

`AfterViewChecked` 只要视图有变化或者可能会有变化(如组件的方法被调用),就会触发,
因此要注意代码效率

## AfterView示例


`/src/app/child/child.component.ts`

```ts
import {
  Component, OnInit, Input, OnChanges, SimpleChanges, DoCheck,
  AfterViewInit, AfterViewChecked
} from '@angular/core';

@Component({
  selector: 'app-child',
  templateUrl: './child.component.html',
  styleUrls: ['./child.component.css']
})
export class ChildComponent implements OnInit, AfterViewInit, AfterViewChecked {
  ngOnInit(): void {

  }
  greeting(name: string) {
    console.log('hello ' + name);
  }

  ngAfterViewInit(): void {
    console.log('子组件的视图初始化完毕');
  }

  ngAfterViewChecked(): void {
    console.log('子组件的视图变更检测完毕');
  }
}
```

`/src/app/app.component.html`

```html
<app-child #child1></app-child>
<app-child #child2></app-child>
<button (click)="child2.greeting('Jerry')">调用child2的greeting方法</button>
<br>
<p>{{message}}</p>
```

`/src/app/app.component.ts`

```ts
import { ChildComponent } from './child/child.component';
import { Component, ViewChild, OnInit, AfterViewInit, AfterViewChecked } from '@angular/core';


@Component({
  selector: 'app-root',
  templateUrl: './app.component.html',
  styleUrls: ['./app.component.css']
})
export class AppComponent implements OnInit, AfterViewInit, AfterViewChecked {

  message: string;

  @ViewChild('child1')
  child1: ChildComponent;

  constructor() { }

  ngOnInit(): void {
    // this.child1.greeting("Tom");
    setInterval(() => {
      this.child1.greeting('Tom');
    }, 5000);

  }
  ngAfterViewChecked(): void {
    console.log('父组件的视图变更检测完毕');
    // this.message = 'Hello';
  }
  ngAfterViewInit(): void {
    console.log('父组件的视图初始化完毕');
    // this.message = 'Hello';
    setTimeout(() => {
      this.message = 'Hello';
    }, 0);
  }
}

```

### 要注意的地方

`AfterView` 钩子是在模板视图组合完成后触发的,
因此不允许在视图完成后,修改组件的属性,如果在钩子里修改属性,是会报错的.

解决方法是 用 `setTimeout` 处理



