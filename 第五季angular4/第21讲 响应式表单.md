# 第21讲 响应式表单

## 本讲项目介绍

### 项目名称

`myrxform`

github 项目地址


备课项目

`myrxform-test`

github 项目地址


分支 E21


### 初始准备

- 新建普通项目
- 引入jquery bootstrap 第三包

```bash
ng new myrxform --skip-install

cd myrxform

npm install --registry=https://registry.npm.taobao.org --disturl=https://npm.taobao.org/dist --sass-binary-site=http://npm.taobao.org/mirrors/node-sass

ng serve

npm install jquery bootstrap @types/jquery @types/bootstrap --save --registry=https://registry.npm.taobao.org --disturl=https://npm.taobao.org/dist --sass-binary-site=http://npm.taobao.org/mirrors/node-sass

```


`.angular-cli.json`

```
      "styles": [
        "styles.css",
        "../node_modules/bootstrap/dist/css/bootstrap.css"
      ],
      "scripts": [
        "../node_modules/jquery/dist/jquery.js",
        "../node_modules/bootstrap/dist/js/bootstrap.js"
      ],
```


## 创建响应式表单的步骤

- 引入响应式表单模块
- 创建数据模型
- 创建表单视图模板
- 视图模板绑定数据模型

## 创建新的示例项目 myapp-form

## 创建表单组件

`ng g c formdemo1`

## 响应式表单模块

`/src/app/app.module.ts`

```ts
//...
import { FormsModule, ReactiveFormsModule } from '@angular/forms';
//...

@NgModule({
  //...
  imports: [
    //...
    ReactiveFormsModule
  ],
  providers: [],
  bootstrap: [AppComponent]
})
```




## 数据模型

### 相关类

- FormControl : 输入元素控制器(表单控制器), 
- FormGroup : 以Key-value形式包含多个FormControl的容器, 通常代表整个表单
- FormArray : 以数组形式包含多个FormControl的容器,常用于需要增长的元素集合

```ts
import { FormControl, FormGroup, FormArray } from '@angular/forms';
```

相关api文档
[https://angular.cn/docs/ts/latest/api/forms/index/AbstractControl-class.html]


### 如何创建FormControl

```ts
userName: FormControl = new FormControl('abc');
```

> 参数表示初始值

### 如何创建FormGroup

```ts
  dateGroup: FormGroup = new FormGroup({
    from: new FormControl(),
    to: new FormControl()
  });
```

### 如何创建FormArray

```ts
  emails: FormArray = new FormArray([
    new FormControl('a@abc.com'),
    new FormControl('b@abc.com'),
    new FormControl('c@abc.com'),
  ]);
```

### 先写一个基本的表单视图

`/src/app/formdemo1/formdemo1.component.html`

```html
<form>
  <div>
    名称:<input type="text">
  </div>
  <div>
    <div>
      开始日期:<input type="date">
    </div>
    <div>
      结束日期:<input type="date">
    </div>
  </div>
  <div>
    <ul>
      <li><input type="text"></li>
      <button type="button">新增email</button>
    </ul>
    <div>
      <button type="submit">保存</button>
    </div>
  </div>
</form>
```

### 创建代表整个表单的数据模型

```ts
  formModel: FormGroup = new FormGroup({});
  onSubmit() {
    console.log(this.formModel.value);
  }  
```

### 在视图绑定表单模型

`/src/app/formdemo1/formdemo1.component.html`

```html
<form [formGroup]="formModel" (submit)="onSubmit()">
```

### 将表单数据模型添加完整


`/src/app/formdemo1/formdemo1.component.ts`

```ts
  userName: FormControl = new FormControl('abc');

  dateGroup: FormGroup = new FormGroup({
    from: new FormControl(),
    to: new FormControl()
  });

  emails: FormArray = new FormArray([
    new FormControl('a@abc.com'),
    new FormControl('b@abc.com'),
    new FormControl('c@abc.com'),
  ]);

  formModel: FormGroup = new FormGroup({
    userName: this.userName,
    date: this.dateGroup,
    emails: this.emails,
  });
```

也可以直接写成:

```ts
  formModel: FormGroup = new FormGroup({
    userName: new FormControl('abc'),
    date: new FormGroup({
      from: new FormControl(),
      to: new FormControl()
      }),
    emails: new FormArray([
      new FormControl('a@abc.com'),
      new FormControl('b@abc.com'),
      new FormControl('c@abc.com'),
      ]),
  });
```


### 在视图绑定表单元素

`/src/app/formdemo1/formdemo1.component.html`

```html
<form [formGroup]="formModel" (submit)="onSubmit()">
  <div>
    名称:<input type="text" formControlName="userName">
  </div>
  <div formGroupName="date">
    <div>
      开始日期:<input type="date" formControlName="from">
    </div>
    <div>
      结束日期:<input type="date" formControlName="to">
    </div>
  </div>
  <div>
    <ul formArrayName="emails">
      <li *ngFor="let email of formModel.get('emails').controls; index as i">
        <input type="text" [formControlName]="i">
      </li>
      <button type="button">新增email</button>
    </ul>
    <div>
      <button type="submit">保存</button>
    </div>
  </div>
</form>
```

### 实现新增

```ts
  addEmail() {
    this.emails.push(new FormControl());
  }
```

```html
      <button type="button" (click)="addEmail()">新增email</button>
```

另一种写法:

```ts
  addEmail() {
    const emails = this.formModel.get('emails') as FormArray;
    emails.push(new FormControl());
  }
```

### 绑定指令

formGroup  (用于顶级绑定) ([属性绑定])
formControl  (用于顶级绑定)([属性绑定]) (不常用,非表单内部的元素才会用到)

formGroupName (用于子级绑定) (一般情况只需要普通绑定)
formControlName (用于子级绑定) (一般情况只需要普通绑定)

formArrayName(用于绑定formArray)

### get

get 的定义:

>  get(path: Array<string | number> | string): AbstractControl | null;

get 的使用说明:

```js
    /**
     * Retrieves a child control given the control's name or path.
     *
     * Paths can be passed in as an array or a string delimited by a dot.
     *
     * To get a control nested within a `person` sub-group:
     *
     * * `this.form.get('person.name');`
     *
     * -OR-
     *
     * * `this.form.get(['person', 'name']);`
     */
```

### 注册表单示例

`ng g c regForm`

#### FormBuilder

使用 FormBuilder 来构建表单模型

FormBuilder类能通过处理控件创建的细节问题来帮我们减少重复劳动。

FormBuilder.group是一个用来创建FormGroup的工厂方法，它接受一个对象，对象的键和值分别是FormControl的名字和它的定义。 在这个例子中，name控件的初始值是空字符串。

把一组控件定义在一个单一对象中，可以更加紧凑、易读。 完成相同功能时，这种形式优于一系列new FormControl(...)语句。

#### 使用 FormBuilder 的步骤

- 注入 `FormBuilder`
- 调用 group 方法开始创建

`/src/app/reg-form/reg-form.component.ts`

```ts
import { Component, OnInit } from '@angular/core';
import { FormBuilder, FormGroup } from '@angular/forms';

@Component({
  selector: 'app-reg-form',
  templateUrl: './reg-form.component.html',
  styleUrls: ['./reg-form.component.css']
})
export class RegFormComponent implements OnInit {

  formModel: FormGroup;

  constructor(private fb: FormBuilder) {
    
  }

  ngOnInit() {
    this.createForm();
  }

  createForm() {
    this.formModel = this.fb.group(
      {
        username: [''],
        mobile: [''],
        passwordsGroup: this.fb.group({
          password: [''],
          confirmpw: ['']
        })
      }
    );
  }
  onSubmit() {
    console.log(this.formModel.value);
  }

}

```

`/src/app/reg-form/reg-form.component.html`

```html
<form [formGroup]="formModel" (submit)="onSubmit()">
  <div>用户名:
    <input type="text" formControlName="username">
  </div>
  <div>手机号:
    <input type="text" formControlName="mobile">
  </div>
  <div formGroupName="passwordsGroup">
    <div>密码:
      <input type="password" formControlName="password">
    </div>
    <div>确认密码:
      <input type="password" formControlName="confirmpw">
    </div>
  </div>
  <button type="submit">注册</button>
</form>
<pre>{{formModel.value|json}}</pre>
<pre>{{formModel.status|json}}</pre>
```

每个控制器的设置都是控制器名字和数组值。 第一个数组元素是英雄控件对应的当前值。 第二个值（可选）是验证器函数或者验证器函数数组。

`/src/app/app.component.html`

```html
<h3>简单响应式表单示例</h3>
<app-formdemo1></app-formdemo1>
<hr/>
<h3>注册表单示例 FormBuilder</h3>
<app-reg-form></app-reg-form>
```

## 表单校检

### 预定义校检器

`Validators`

```ts
/**
 * Provides a set of validators used by form controls.
 *
 * A validator is a function that processes a {@link FormControl} or collection of
 * controls and returns a map of errors. A null map means that validation has passed.
 *
 * ### Example
 *
 * ```typescript
 * var loginControl = new FormControl("", Validators.required)
 * ```
 *
 * @stable
 */
export declare class Validators {
    /**
     * Validator that requires controls to have a non-empty value.
     */
    static required(control: AbstractControl): ValidationErrors | null;
    /**
     * Validator that requires control value to be true.
     */
    static requiredTrue(control: AbstractControl): ValidationErrors | null;
    /**
     * Validator that performs email validation.
     */
    static email(control: AbstractControl): ValidationErrors | null;
    /**
     * Validator that requires controls to have a value of a minimum length.
     */
    static minLength(minLength: number): ValidatorFn;
    /**
     * Validator that requires controls to have a value of a maximum length.
     */
    static maxLength(maxLength: number): ValidatorFn;
    /**
     * Validator that requires a control to match a regex to its value.
     */
    static pattern(pattern: string | RegExp): ValidatorFn;
    /**
     * No-op validator.
     */
    static nullValidator(c: AbstractControl): ValidationErrors | null;
    /**
     * Compose multiple validators into a single function that returns the union
     * of the individual error maps.
     */
    static compose(validators: null): null;
    static compose(validators: (ValidatorFn | null | undefined)[]): ValidatorFn | null;
    static composeAsync(validators: (AsyncValidatorFn | null)[]): AsyncValidatorFn | null;
}
```

### 自定义校检

自定义验证函数 接受一个 Angular 控制器对象，并在控制器值有效时返回 null ，或无效时返回验证错误对象。 

验证错误对象通常有一个名为 验证错误标识 key  的属性。

其值为一个任意词典，我们可以用来插入错误信息（{name}）。

```ts
xxxxx(control: AbstractControl): {[key: string]: any} => {
    const value = control.value;
    const no = value !== '';
    return no ? {'key': {name:'xxx'}} : null;
  };
```

### 添加 username 的校验

`/src/app/reg-form/reg-form.component.ts`

```ts
import { Component, OnInit } from '@angular/core';
import { FormBuilder, FormGroup, Validators } from '@angular/forms';

@Component({
  selector: 'app-reg-form',
  templateUrl: './reg-form.component.html',
  styleUrls: ['./reg-form.component.css']
})
export class RegFormComponent implements OnInit {

  formModel: FormGroup;

  constructor(private fb: FormBuilder) {

  }

  ngOnInit() {
    this.createForm();
  }

  createForm() {
    this.formModel = this.fb.group(
      {
        username: ['', [Validators.required, Validators.minLength(6)]],
        mobile: [''],
        passwordsGroup: this.fb.group({
          password: [''],
          confirmpw: ['']
        })
      }
    );
  }
  onSubmit() {
    console.log(this.formModel.value);
    console.log(this.formModel);

    if (!this.formModel.get('username').valid) {
      console.log('username 校验失败:',
        JSON.stringify(this.formModel.get('username').errors));
    }
  }

}

```

添加更多的预定义校验器

```ts
import { Component, OnInit } from '@angular/core';
import { FormBuilder, FormGroup, Validators } from '@angular/forms';

@Component({
  selector: 'app-reg-form',
  templateUrl: './reg-form.component.html',
  styleUrls: ['./reg-form.component.css']
})
export class RegFormComponent implements OnInit {

  formModel: FormGroup;

  constructor(private fb: FormBuilder) {

  }

  ngOnInit() {
    this.createForm();
  }

  createForm() {
    this.formModel = this.fb.group(
      {
        username: ['', [Validators.required, Validators.minLength(6)]],
        mobile: ['', Validators.pattern(/^1[0-9]{10}$/)],
        passwordsGroup: this.fb.group({
          password: ['', [Validators.required, Validators.minLength(6)]],
          confirmpw: ['']
        })
      }
    );
  }
  onSubmit() {
    console.log(this.formModel.value);
    console.log(this.formModel);

    if (!this.formModel.valid) {
      if (!this.formModel.get('username').valid) {
        console.log('username 校验失败:',
          JSON.stringify(this.formModel.get('username').errors));
      }
      if (!this.formModel.get('mobile').valid) {
        console.log('mobile 校验失败:',
          JSON.stringify(this.formModel.get('mobile').errors));
      }
      if (!this.formModel.get('passwordsGroup.password').valid) {
        console.log('password 校验失败:',
          JSON.stringify(this.formModel.get('passwordsGroup.password').errors));
      }
    }
  }

}

```

### 添加自定义校验


